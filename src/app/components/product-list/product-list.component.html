<!-- Ficha Mis Productos -->
<header id="main-header" class="pb-2 bg-info text-white main-board-style">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-8" [@fadeAnimation]>
        <h1><i class="fas fa-list"></i> Mis productos</h1>
      </div>
      <div class="col-md-4 search-input-pointer">
        <label for="productSearch">Buscar producto:</label>
        <input
          type="search"
          #productSearch
          id="productSearch"
          [(ngModel)]="searchTerm"
          (ngModelChange)="filterProducts(productSearch.value)"
          class="form-control"
          placeholder="Ingresa tu búsqueda aquí..."
          autocomplete="off"
        />
      </div>
    </div>
  </div>
</header>

<!-- Tabla con la lista de productos -->
<div class="container modal-container mt-4" [@fadeAnimation]>
  <div
    class="modal-content modal-dialog-scrollable shadow"
    style="max-width: 100%; margin: 0 auto"
  >
    <div class="card-header product-list-header border">
      <div class="row">
        <div class="col-md-6 align-items-center">
          <!-- Encabezado del listado -->
          <h4 class="h4">Lista de productos</h4>
        </div>
        <div class="col-md-6 d-flex justify-content-md-end">
          <!-- Contenedor de los botones Agregar, Anterior y Siguiente -->
          <div class="d-flex align-items-center">
            <button
              class="btn btn-primary border-primary shadow clic-on-image mr-4"
              data-toggle="modal"
              data-target="#productModal"
              (click)="openProductModal(false, 0); this.editMode = false"
              [disabled]="getUserRole() === 'user'"
            >
              Agregar
            </button>
            <button
              class="btn btn-warning border-warning shadow clic-on-image mr-2"
              (click)="prevPage()"
              [disabled]="page === 0"
              style="color: white !important"
            >
              <span><i class="fa-solid fa-arrow-left"></i></span>
              <span class="d-md-none"></span>
            </button>
            <button
              class="btn btn-success border-success shadow clic-on-image"
              (click)="nextPage()"
              [disabled]="
                (products | productsFilter : page : searchTerm).length < 8
              "
            >
              <span class="d-md-none"></span>
              <span><i class="fa-solid fa-arrow-right"></i></span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="w-100">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr class="product-detail-table-titles">
              <th class="text-left" style="min-width: 30px"></th>
              <th class="text-left" style="max-width: 200px">Producto</th>
              <th class="text-right" style="min-width: 100px">Disponible</th>
              <th class="text-right" style="min-width: 100px">P. Compra</th>
              <th class="text-right" style="min-width: 75px">Margen</th>
              <th class="text-right" style="min-width: 75px">I.V.A.</th>
              <th class="text-right" style="min-width: 100px; padding-right: 30px;">P. Venta</th>
            </tr>
          </thead>
          <tbody class="">
            <tr
              *ngFor="
                let product of filteredProducts
                  | productsFilter : page : searchTerm;
                let even = even
              "
              [ngClass]="{ 'table-row-even': even, 'table-row-odd': !even }"
              class=""
            >
              <td class="product-code" style="min-width: 30px">
              </td>
              <td
                style="max-width: 200px; min-width: 200px; white-space: nowrap;"
                (click)="product.showIcons = !product.showIcons"
              >
                <div class="d-flex" style="left: 100px;">
                  <span
                    class="product-icons"
                    [ngClass]="{ 'show-icons': product.showIcons }"
                  >
                    <a
                      role="button"
                      class="ml-3 mr-2"
                      data-toggle="modal"
                      data-target="#productModal"
                      (click)="
                        openProductModal(true, product.productId);
                        this.editMode = true
                      "
                    >
                      <i
                        class="fa-solid fa-pen-to-square clic-on-icon"
                        style="color: #1100fa; cursor: pointer"
                      ></i>
                    </a>
                    <a
                      class="mr-2"
                      *ngIf="getUserRole() !== 'user'"
                      data-toggle="modal"
                      data-target="#deletePasswordModal"
                      (click)="openPasswordModal(product.int_code)"
                    >
                      <i
                        class="fas fa-solid fa-trash clic-on-icon"
                        style="color: #fa0000; cursor: pointer"
                      ></i>
                    </a>
                  </span>
                  <span
                    class="product-name"
                    style="cursor: pointer;"
                    tabindex="-1"
                  >
                    {{ product.name }}
                  </span>
                  
                </div>
              </td>
              <td class="text-right" style="min-width: 100px">
                {{ product.quantity | number : "1.2-2" }}
              </td>
              <td class="text-right" style="min-width: 100px">
                {{ product.purchase_price | currency : "CRC" : "₡" }}
              </td>
              <td class="text-right" style="min-width: 75px">
                {{ product.margin | number : "1.2-2" }} %
              </td>
              <td class="text-right" style="min-width: 75px">
                {{ product.taxPercentage | number : "1.1-1" }} %
              </td>
              <td class="text-right price-cell" style="min-width: 100px; padding-right: 30px;">
                {{ product.sale_price | currency : "CRC" : "₡" }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div style="margin-bottom: 80px"></div>

<!-- Botón para ir al principio de la lista -->
<!-- <button
  class="btn btn-primary btn-floating shadow clic-on-image"
  (click)="scrollToTop()"
>
  <i class="fas fa-arrow-up"></i>
</button> -->

<!-- Modal para agregar/editar producto -->
<div
  class="modal fade"
  id="productModal"
  #productModal
  tabindex="-1"
  role="dialog"
  aria-labelledby="productModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content shadow">
      <div class="modal-header border">
        <h5 class="modal-title" id="productModalLabel">
          {{ modalTitle }} de producto
        </h5>
        <button
          type="button"
          aria-label="Close"
          class="close"
          data-dismiss="modal"
          (click)="closeProductModal()"
        >
          <span aria-hidden="true">
            <i class="fas fa-close"></i>
          </span>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="productForm">
          <div class="form-group">
            <label for="int_code">Código:</label>
            <input
              type="text"
              class="form-control"
              id="int_code"
              formControlName="int_code"
              name="int_code"
              required
              #codeInput
              (input)="handleCodeInput($event.target)"
              (keypress)="disableEnterKey($event)"
              [ngClass]="{
                'is-valid':
                  productForm.get('int_code').touched &&
                  productForm.get('int_code').valid,
                'is-invalid':
                  productForm.get('int_code').touched &&
                  productForm.get('int_code').invalid
              }"
            />
          </div>
          <div class="form-group">
            <label for="productName">Nombre:</label>
            <input
              type="text"
              class="form-control"
              id="productName"
              formControlName="name"
              name="name"
              required
              #nameInput
              [ngClass]="{
                'is-valid':
                  productForm.get('name').touched &&
                  productForm.get('name').valid,
                'is-invalid':
                  productForm.get('name').touched &&
                  productForm.get('name').invalid
              }"
            />
          </div>
          <div class="form-group">
            <label for="productDescription">Descripción:</label>
            <textarea
              class="form-control"
              id="productDescription"
              formControlName="description"
              name="description"
              rows="3"
              [ngClass]="{
                'is-valid':
                  productForm.get('description').touched &&
                  productForm.get('description').valid,
                'is-invalid':
                  productForm.get('description').touched &&
                  productForm.get('description').invalid
              }"
            ></textarea>
          </div>
          <div class="form-group form-row">
            <div class="col">
              <label for="purchase_price">Precio de compra:</label>
              <input
                type="number"
                class="form-control text-right"
                id="purchase_price"
                formControlName="purchase_price"
                name="purchase_price"
                (change)="calculateTotal(true)"
                pattern="^[0-9]+(\.[0-9]{1,2})?$"
                step="0.01"
                required
                [ngClass]="{
                  'is-valid':
                    productForm.get('purchase_price').touched &&
                    productForm.get('purchase_price').valid,
                  'is-invalid':
                    productForm.get('purchase_price').touched &&
                    productForm.get('purchase_price').invalid
                }"
              />
            </div>
            <div class="col">
              <label for="sale_price">Precio de venta:</label>
              <input
                type="number"
                class="form-control text-right"
                id="sale_price"
                formControlName="sale_price"
                name="sale_price"
                (change)="calculateTotal(true)"
                pattern="^[0-9]+(\.[0-9]{1,2})?$"
                readonly
              />
            </div>
          </div>
          <div class="form-group form-row">
            <div class="col">
              <label for="productMargin">Margen de ganancia (%):</label>
              <input
                type="number"
                class="form-control text-right"
                id="productMargin"
                formControlName="margin"
                name="margin"
                (change)="calculateTotal(true)"
                required
                step="0.001"
                pattern="^[0-9]+(\.[0-9]{1,3})?$"
                [ngClass]="{
                  'is-valid':
                    productForm.get('margin').touched &&
                    productForm.get('margin').valid,
                  'is-invalid':
                    productForm.get('margin').touched &&
                    productForm.get('margin').invalid
                }"
              />
            </div>
            <div class="col">
              <label for="taxes">Impuestos (%):</label>
              <label for="taxPercentage" class="form-check-label ml-5">
                <input
                  type="checkbox"
                  id="taxes"
                  class="form-check-input shadow"
                  formControlName="taxes"
                  name="taxes"
                  (change)="toggleTaxPercentage(); calculateTotal(true)"
                />
                {{ productForm.get("taxes").value ? "Gravado" : "Exento" }}
              </label>
              <input
                type="number"
                class="form-control text-right"
                id="taxPercentage"
                formControlName="taxPercentage"
                name="taxPercentage"
                (change)="calculateTotal(true)"
                [value]="getTaxPercentageValue()"
                required
                min="0"
                max="100"
                pattern="^[0-9]+(\.[0-9]{1,2})?$"
                [ngClass]="{
                  'is-valid':
                    productForm.get('taxPercentage').touched &&
                    productForm.get('taxPercentage').valid,
                  'is-invalid':
                    productForm.get('taxPercentage').touched &&
                    productForm.get('taxPercentage').invalid
                }"
              />
            </div>
          </div>

          <div class="modal-footer">
            <button
              *ngIf="this.editMode === false && getUserRole() !== 'user'"
              type="button"
              class="btn btn-primary shadow clic-on-image"
              (click)="createProduct($event)"
              data-dismiss="modal"
            >
              Guardar
            </button>
            <button
              *ngIf="this.editMode === true && getUserRole() !== 'user'"
              type="button"
              class="btn btn-primary shadow clic-on-image"
              (click)="editProduct(productForm.get('productId').value)"
            >
              Editar
            </button>
            <button
              type="button"
              class="btn btn-secondary shadow clic-on-image"
              data-dismiss="modal"
              (click)="closeProductModal()"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal contraseña para eliminar producto -->
<div
  class="modal fade"
  id="deletePasswordModal"
  #deletePasswordModal
  tabindex="-1"
  role="dialog"
  aria-labelledby="deletePasswordModalLabel"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-dialog-centered"
    role="document"
    style="width: 300px"
  >
    <div class="modal-content shadow">
      <div class="modal-header border">
        <h5 class="modal-title">Eliminar producto</h5>
        <button
          class="close"
          (click)="closePasswordModal()"
          data-dismiss="modal"
        >
          <span aria-hidden="true"><i class="fas fa-close"></i></span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="deleteProduct">Producto a eliminar:</label>
            <input
              type="text"
              id="deleteProduct"
              class="form-control"
              name="name"
              [value]="productForm.get('name').value"
              autocomplete="off"
            />
            <label for="password">Contraseña:</label>
            <input
              type="password"
              id="password"
              class="form-control"
              name="password"
              [(ngModel)]="password"
              autocomplete="off"
            />
          </div>
          <div class="modal-footer">
            <button
              type="submit"
              class="btn btn-primary clic-on-image"
              data-dismiss="modal"
              (click)="deleteProduct(productForm.get('int_code').value)"
            >
              Guardar
            </button>
            <button
              type="button"
              class="btn btn-secondary clic-on-image"
              (click)="closePasswordModal()"
              data-dismiss="modal"
            >
              Cerrar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
